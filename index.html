<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bloxd Code Block ãƒ‰ãƒƒãƒˆçµµã‚³ãƒ³ãƒãƒ¼ã‚¿ãƒ¼</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Tailwindã®è¨­å®šã‚’ã‚ˆã‚Šãƒ¢ãƒ€ãƒ³ãªãƒ‘ãƒ¬ãƒƒãƒˆã«èª¿æ•´
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'bloxd-primary': '#3b82f6', // Blue for main actions
                        'bloxd-secondary': '#10b981', // Green for success/conversion
                        'bloxd-dark-bg': '#f8fafc', // Light background
                        'bloxd-card-bg': '#ffffff',
                        'bloxd-wool': '#f1f5f9', // Soft background for input area
                        'code-dark': '#1f2937', // Dark for code block
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
        }
        /* ã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ (ã‚³ãƒ¼ãƒ‰ã‚¨ãƒªã‚¢ç”¨) */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #64748b;
            border-radius: 10px;
        }
        /* ãƒ”ã‚¯ã‚»ãƒ«ã‚¢ãƒ¼ãƒˆè¡¨ç¤ºã®ãŸã‚ã®è¨­å®š */
        .image-rendering-pixelated {
            image-rendering: optimizeSpeed; 
            image-rendering: -moz-crisp-edges;
            image-rendering: -o-crisp-edges; 
            image-rendering: pixelated;
        }
        /* ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªã‚¿ãƒ–ãƒœã‚¿ãƒ³ã®ãƒ‡ã‚¶ã‚¤ãƒ³ã‚’æ”¹å–„ */
        .tab-button.active {
            background-color: #10b981;
            color: white;
            font-weight: 600;
            border-bottom: 3px solid #059669; /* ã‚ˆã‚Šæ¿ƒã„è‰²ã§å¼·èª¿ */
        }
    </style>
</head>
<body class="p-4 sm:p-8 bg-bloxd-dark-bg min-h-screen flex justify-center items-start">

    <div id="app" class="w-full max-w-4xl bg-bloxd-card-bg shadow-2xl rounded-xl p-6 sm:p-10 my-8">
        
        <h1 class="text-3xl sm:text-4xl font-extrabold text-bloxd-primary mb-2 text-center border-b pb-3">
            ğŸ§± Bloxd Code Block ãƒ‰ãƒƒãƒˆçµµã‚³ãƒ³ãƒãƒ¼ã‚¿ãƒ¼
        </h1>
        <p class="text-center text-gray-600 mb-8 mt-2">
            Code Blockã®åˆ¶é™ (15,000æ–‡å­—) ã«åˆã‚ã›ã¦ã‚³ãƒ¼ãƒ‰ã‚’è‡ªå‹•åˆ†å‰²ã—ã€ç”»åƒã®ãƒ‰ãƒƒãƒˆçµµã‚’ç”Ÿæˆã—ã¾ã™ã€‚
        </p>

        <!-- ã‚¹ãƒ†ãƒƒãƒ— 1: è¨­å®šã¨å…¥åŠ›ã‚¨ãƒªã‚¢ -->
        <div class="space-y-8 p-6 bg-bloxd-wool rounded-xl shadow-inner border border-gray-200">
            <h2 class="text-2xl font-bold text-gray-800 flex items-center">
                <span class="bg-bloxd-secondary text-white rounded-full w-8 h-8 flex items-center justify-center mr-3 text-lg">1</span>
                ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã¨æç”»è¨­å®š
            </h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <!-- æç”»åº§æ¨™è¨­å®š -->
                <div class="col-span-1 space-y-4 p-4 bg-white rounded-lg shadow-md">
                    <label class="block text-lg font-semibold text-gray-800">
                        æç”»é–‹å§‹åº§æ¨™ (X, Y, Z)
                    </label>
                    <div class="flex space-x-2">
                        <input type="number" id="startX" placeholder="X (å›ºå®šè»¸)" value="100" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-bloxd-primary focus:border-bloxd-primary transition duration-150 shadow-sm"/>
                        <input type="number" id="startY" placeholder="Y (é«˜ã•)" value="60" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-bloxd-primary focus:border-bloxd-primary transition duration-150 shadow-sm"/>
                        <input type="number" id="startZ" placeholder="Z (å¹…)" value="200" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-bloxd-primary focus:border-bloxd-primary transition duration-150 shadow-sm"/>
                    </div>
                    <p class="mt-1 text-xs text-gray-500">
                        Code BlockãŒè¨­ç½®ã•ã‚ŒãŸä½ç½®ã‚’åŸºæº–ã¨ã—ãŸçµ¶å¯¾åº§æ¨™ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚
                    </p>
                </div>

                <!-- è§£åƒåº¦ã¨ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ› -->
                <div class="col-span-1 space-y-4 p-4 bg-white rounded-lg shadow-md">
                    <div class="flex flex-col sm:flex-row gap-4">
                        <div class="flex-1">
                            <label for="resolution" class="block text-lg font-semibold text-gray-800">è§£åƒåº¦ (N x N ãƒ–ãƒ­ãƒƒã‚¯)</label>
                            <select id="resolution" class="w-full mt-1 p-3 border border-gray-300 rounded-lg focus:ring-bloxd-primary focus:border-bloxd-primary transition duration-150 shadow-sm">
                                <option value="20" selected>20x20 (400ãƒ–ãƒ­ãƒƒã‚¯)</option>
                                <option value="30">30x30 (900ãƒ–ãƒ­ãƒƒã‚¯)</option>
                                <option value="40">40x40 (1600ãƒ–ãƒ­ãƒƒã‚¯)</option>
                                <option value="50">50x50 (2500ãƒ–ãƒ­ãƒƒã‚¯)</option>
                                <option value="75">75x75 (5625ãƒ–ãƒ­ãƒƒã‚¯)</option>
                                <option value="100">100x100 (10000ãƒ–ãƒ­ãƒƒã‚¯)</option>
                            </select>
                        </div>
                        <div class="flex-1">
                            <label for="imageUpload" class="block text-lg font-semibold text-gray-800">ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</label>
                            <input type="file" id="imageUpload" accept="image/*" class="w-full mt-1 text-sm text-gray-600
                                file:mr-4 file:py-2 file:px-4
                                file:rounded-full file:border-0
                                file:text-sm file:font-semibold
                                file:bg-bloxd-primary file:text-white
                                hover:file:bg-blue-600 cursor-pointer transition duration-150
                            "/>
                        </div>
                    </div>
                    <p class="text-xs text-gray-500">ãƒ‘ãƒ¬ãƒƒãƒˆ: **Concrete (16è‰²)** ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚</p>
                </div>
            </div>
            
            <div class="pt-4 flex justify-center">
                <button id="convertButton"
                    class="flex items-center space-x-2 px-10 py-4 bg-bloxd-secondary text-white text-xl font-bold rounded-full shadow-lg hover:bg-emerald-600 transition duration-300 transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed">
                    <span>ğŸ–¼ï¸ å¤‰æ›ã—ã¦ã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆ</span>
                </button>
            </div>
        </div>
        
        <!-- ã‚¹ãƒ†ãƒƒãƒ— 2: ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¨å‡ºåŠ›ã‚¨ãƒªã‚¢ -->
        <div id="outputSection" class="space-y-8 mt-10 p-6 bg-white rounded-xl shadow-lg border border-gray-300" style="display: none;">
            <h2 class="text-2xl font-bold text-gray-800 flex items-center">
                <span class="bg-bloxd-secondary text-white rounded-full w-8 h-8 flex items-center justify-center mr-3 text-lg">2</span>
                ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¨ Code Block ç”¨ã‚³ãƒ¼ãƒ‰
            </h2>

            <div class="flex flex-col md:flex-row gap-8">
                <!-- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ -->
                <div class="md:w-1/3 flex flex-col items-center p-4 bg-gray-50 rounded-lg shadow-inner">
                    <h3 class="font-bold text-lg text-gray-700 mb-4">å¤‰æ›ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ (<span id="previewResolution">20x20</span>)</h3>
                    <canvas id="previewCanvas" width="20" height="20" class="w-full max-w-xs h-auto rounded-md shadow-xl border-4 border-gray-400 image-rendering-pixelated"></canvas>
                    <p class="text-xs text-gray-500 mt-3 text-center">
                        Code Blockã§æç”»ã•ã‚Œã‚‹ãƒ‰ãƒƒãƒˆçµµã®è¦‹ãŸç›®ã§ã™ã€‚
                    </p>
                </div>

                <!-- ã‚³ãƒ¼ãƒ‰å‡ºåŠ› (ã‚¿ãƒ–UI) -->
                <div class="md:w-2/3">
                    <h3 class="font-bold text-lg text-gray-700 mb-2">Code Block JavaScript (æœ€å¤§15,000æ–‡å­—ã§åˆ†å‰²)</h3>
                    <p class="text-xs text-red-600 mb-4 font-bold p-2 bg-red-100 rounded-md">
                        âš ï¸ Code Block ã”ã¨ã«å†…å®¹ã‚’ã‚³ãƒ”ãƒ¼ã—ã€é †ç•ªã« Code Block ã«è²¼ã‚Šä»˜ã‘ã¦å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚
                    </p>
                    
                    <!-- ã‚¿ãƒ–ãƒœã‚¿ãƒ³ -->
                    <div id="tabButtons" class="flex border-b-2 border-bloxd-secondary mb-4 overflow-x-auto">
                        <!-- ãƒœã‚¿ãƒ³ã¯JSã§å‹•çš„ã«è¿½åŠ ã•ã‚Œã¾ã™ -->
                    </div>

                    <!-- ã‚¿ãƒ–å†…å®¹ -->
                    <div id="tabContent">
                        <!-- Code Block ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã¯JSã§å‹•çš„ã«è¿½åŠ ã•ã‚Œã¾ã™ -->
                        <p id="copyMessage" class="mt-3 px-3 py-1 bg-green-100 text-green-700 font-semibold rounded inline-block hidden">âœ… ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼</p>
                    </div>
                </div>
            </div>
        </div>

        <div id="loading" class="text-center text-xl text-bloxd-secondary font-semibold mt-10 hidden">
            <div class="animate-spin inline-block w-8 h-8 border-4 border-bloxd-secondary border-t-transparent rounded-full"></div>
            <p class="mt-3">ç”»åƒã‚’è§£æã—ã€Code Block ç”¨ã®ã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆä¸­...</p>
        </div>

    </div>

    <script>
        /* å®šæ•°ã‚’è¨­å®š */
        var BASE_BLOCK_TYPE_FULL = " Concrete"; 
        var MAX_PREVIEW_SIZE = 400; 
        
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è¦æœ›ã«ã‚ˆã‚Šã€15,000æ–‡å­—åˆ¶é™ã‚’é©ç”¨ã—ã¾ã™ã€‚å®‰å…¨ãƒãƒ¼ã‚¸ãƒ³ã¨ã—ã¦14,900æ–‡å­—ã‚’ä½¿ç”¨ã€‚
        const MAX_CHARS_PER_CHUNK = 14900; 

        /* ãƒ¦ãƒ¼ã‚¶ãƒ¼æŒ‡å®šã®ã‚³ãƒ³ã‚¯ãƒªãƒ¼ãƒˆãƒ–ãƒ­ãƒƒã‚¯ãƒ‘ãƒ¬ãƒƒãƒˆ (è‰²åã¨RGBè¿‘ä¼¼å€¤) */
        var BLOXD_COLORS = {
            'White': [200, 203, 207], 'Light Gray': [135, 137, 140], 'Gray': [80, 80, 84], 'Black': [25, 27, 30],
            'Brown': [95, 60, 42], 'Red': [142, 38, 32], 'Orange': [220, 94, 25], 'Yellow': [237, 178, 20],
            'Lime': [95, 169, 21], 'Green': [77, 98, 32], 'Cyan': [18, 126, 133], 'Light Blue': [65, 137, 186],
            'Blue': [43, 44, 138], 'Purple': [112, 45, 166], 'Magenta': [178, 59, 141], 'Pink': [215, 108, 138]
        };

        /**
         * 2ã¤ã®RGBè‰²ã®é–“ã®è·é›¢ (R^2 + G^2 + B^2) ã‚’è¨ˆç®—
         */
        function colorDistance(rgb1, rgb2) {
            return Math.pow(rgb1[0] - rgb2[0], 2) + Math.pow(rgb1[1] - rgb2[1], 2) + Math.pow(rgb1[2] - rgb2[2], 2);
        }

        /**
         * æœ€ã‚‚è¿‘ã„Bloxdã®ãƒ–ãƒ­ãƒƒã‚¯è‰²ã‚’æ±ºå®š (ãƒ¦ãƒ¼ãƒ©ãƒŸã‚¢ãƒ³è·é›¢ã‚’ä½¿ç”¨)
         */
        function findNearestBloxdColor(targetRgb) {
            var minDistance = Infinity;
            var nearestColorName = 'White';

            for (var name in BLOXD_COLORS) {
                var rgb = BLOXD_COLORS[name];
                var distance = colorDistance(targetRgb, rgb);
                if (distance < minDistance) {
                    minDistance = distance;
                    nearestColorName = name;
                }
            }
            return nearestColorName;
        }
        
        /**
         * ç”»åƒã‚’èª­ã¿è¾¼ã¿ã€æŒ‡å®šã‚µã‚¤ã‚ºã«ãƒªã‚µã‚¤ã‚ºã—ã€Bloxdãƒ–ãƒ­ãƒƒã‚¯è‰²åã‚’å«ã‚€ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆãƒ‡ãƒ¼ã‚¿ã¨ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ç”Ÿæˆ
         */
        function processImageToLayout(file, blockSize) {
            return new Promise(function(resolve, reject) {
                var img = new Image();
                var reader = new FileReader();

                reader.onload = function(e) {
                    img.onload = function() {
                        var canvas = document.createElement('canvas');
                        var ctx = canvas.getContext('2d');
                        canvas.width = blockSize;
                        canvas.height = blockSize;

                        /* ç”»åƒã‚’æŒ‡å®šã‚µã‚¤ã‚ºã«æç”»ãƒ»ãƒªã‚µã‚¤ã‚º */
                        ctx.drawImage(img, 0, 0, blockSize, blockSize);
                        
                        /* ãƒ”ã‚¯ã‚»ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾— */
                        var imageData = ctx.getImageData(0, 0, blockSize, blockSize).data;
                        /* ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆãƒ‡ãƒ¼ã‚¿ã¯ã€åº§æ¨™æƒ…å ±ã‚’æŒãŸã›ãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®é…åˆ— */
                        var layoutData = []; 

                        var previewCanvas = document.getElementById('previewCanvas');
                        var previewCtx = previewCanvas ? previewCanvas.getContext('2d') : null; // Null Check

                        if (previewCtx) {
                            previewCtx.clearRect(0, 0, blockSize, blockSize); 
                        } else {
                            console.error("Preview canvas context is null.");
                            return reject(new Error("Preview canvas not available."));
                        }
                        
                        /* ãƒ”ã‚¯ã‚»ãƒ«ã”ã¨ã«å‡¦ç† */
                        for (var i = 0; i < imageData.length; i += 4) {
                            var r = imageData[i];
                            var g = imageData[i + 1];
                            var b = imageData[i + 2];
                            
                            var bloxdColorName = findNearestBloxdColor([r, g, b]);
                            
                            var pixelIndex = i / 4;
                            var z = pixelIndex % blockSize; 
                            var y = Math.floor(pixelIndex / blockSize); /* Yã¯è¡Œ (é«˜ã•) */
                            
                            /* åº§æ¨™ã¨è‰²åã‚’æ ¼ç´ */
                            layoutData.push({ y: y, z: z, color: bloxdColorName });

                            /* ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤ºç”¨ */
                            var bloxdRgb = BLOXD_COLORS[bloxdColorName];
                            previewCtx.fillStyle = "rgb(" + bloxdRgb[0] + "," + bloxdRgb[1] + "," + bloxdRgb[2] + ")";
                            previewCtx.fillRect(z, y, 1, 1);
                        }

                        resolve(layoutData);
                    };
                    img.src = e.target.result;
                };

                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }
        
        /**
         * ãƒ¡ã‚¤ãƒ³ã®å‡¦ç†ã‚’å®Ÿè¡Œã—ã€Code Blockç”¨ã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆã™ã‚‹
         */
        async function startConversion() {
            var fileInput = document.getElementById('imageUpload');
            var resolutionSelect = document.getElementById('resolution');
            var startX = document.getElementById('startX');
            var startY = document.getElementById('startY');
            var startZ = document.getElementById('startZ');
            
            var outputSection = document.getElementById('outputSection');
            var loading = document.getElementById('loading');
            
            var blockSize = parseInt(resolutionSelect.value);
            var x = parseInt(startX.value);
            var y = parseInt(startY.value);
            var z = parseInt(startZ.value);

            // Null Check and error handling for empty file
            if (!fileInput.files[0]) {
                // Using custom alert style rather than window.alert
                showCustomMessage("ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚", 'error');
                return;
            }
            if (isNaN(x) || isNaN(y) || isNaN(z)) {
                showCustomMessage("æç”»é–‹å§‹åº§æ¨™ (X, Y, Z) ã‚’ã™ã¹ã¦æ•°å­—ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚", 'error');
                return;
            }

            /* UIã‚’æ›´æ–° */
            if (loading) loading.classList.remove('hidden');
            if (outputSection) outputSection.style.display = 'none';

            /* ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚­ãƒ£ãƒ³ãƒã‚¹ã®ã‚µã‚¤ã‚ºã‚’æ›´æ–° */
            updatePreviewCanvasSize(blockSize);

            try {
                /* 1. ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆãƒ‡ãƒ¼ã‚¿ (Y, Z, Color) ã‚’ç”Ÿæˆ */
                var blockLayout = await processImageToLayout(fileInput.files[0], blockSize);
                
                /* 2. Code Blockç”¨JavaScriptã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆ (15000æ–‡å­—æœªæº€ã§åˆ†å‰²) */
                var generatedCodeBlocks = generateBloxdCode_IndividualPositions_SplitByChar(blockLayout, x, y, z, blockSize); // blockSizeã‚’æ¸¡ã™
                
                /* 3. å‡ºåŠ›UIã«ã‚³ãƒ¼ãƒ‰ã‚’åæ˜  */
                updateOutputUI(generatedCodeBlocks);
                
                /* UIã‚’æ›´æ–° */
                const previewResolution = document.getElementById('previewResolution');
                if(previewResolution) previewResolution.textContent = blockSize + "x" + blockSize;
                if (outputSection) outputSection.style.display = 'block';
                if (loading) loading.classList.add('hidden');
                
                // åˆå›å¤‰æ›å¾Œã€Code Block 1ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«ã™ã‚‹
                switchTab(1);

            } catch (error) {
                if (loading) loading.classList.add('hidden');
                console.error("è§£æã‚¨ãƒ©ãƒ¼:", error);
                showCustomMessage("ç”»åƒã®è§£æä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚", 'error');
            }
        }

        /**
         * ã‚«ã‚¹ã‚¿ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºï¼ˆalertã®ä»£ã‚ã‚Šï¼‰
         */
        function showCustomMessage(message, type = 'info') {
            const container = document.getElementById('app');
            const messageId = 'custom-temp-message';
            
            // æ—¢å­˜ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒã‚ã‚Œã°å‰Šé™¤
            let existing = document.getElementById(messageId);
            if (existing) existing.remove();
            
            const messageElement = document.createElement('div');
            messageElement.id = messageId;
            messageElement.textContent = message;
            messageElement.className = `fixed top-4 right-4 p-4 rounded-lg shadow-xl text-white font-bold z-50 transition-transform transform duration-300 ${
                type === 'error' ? 'bg-red-600' : 'bg-bloxd-primary'
            }`;
            
            container.appendChild(messageElement);
            
            setTimeout(() => {
                messageElement.style.transform = 'translateX(120%)';
                messageElement.addEventListener('transitionend', () => messageElement.remove());
            }, 3000);
        }
        
        /**
         * ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚­ãƒ£ãƒ³ãƒã‚¹ã®HTMLå±æ€§ã¨ã‚¹ã‚¿ã‚¤ãƒ«ã‚’æ›´æ–°
         */
        function updatePreviewCanvasSize(blockSize) {
            var previewCanvas = document.getElementById('previewCanvas');
            if (!previewCanvas) return; // Null Check

            var ctx = previewCanvas.getContext('2d');
            
            previewCanvas.width = blockSize;
            previewCanvas.height = blockSize;
            
            // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤ºã‚µã‚¤ã‚ºã‚’ä¸€å®šã®æœ€å¤§ã‚µã‚¤ã‚ºã«åã¾ã‚‹ã‚ˆã†ã«ã‚¹ã‚±ãƒ¼ãƒ«
            var containerWidth = previewCanvas.parentElement.offsetWidth * 0.9;
            var size = Math.min(containerWidth, MAX_PREVIEW_SIZE);

            previewCanvas.style.width = size + 'px';
            previewCanvas.style.height = size + 'px';

            if (ctx) { // Null Check
                ctx.setTransform(1, 0, 0, 1, 0, 0); 
                // ã‚­ãƒ£ãƒ³ãƒã‚¹ã®ãƒ”ã‚¯ã‚»ãƒ«ã‚’ç­‰å€ã§æç”»ã™ã‚‹ãŸã‚ã«ã€æç”»å†…å®¹ã®ã‚¹ã‚±ãƒ¼ãƒ«ã¯1ã«ã™ã‚‹
                // å®Ÿéš›ã®æ‹¡å¤§ã¯CSSã®image-rendering: pixelated; ã¨ width/heightã§è¡Œã†
                ctx.imageSmoothingEnabled = false;
            }
        }

        /**
         * æœ€çµ‚çš„ãªBloxd Code Blockç”¨JavaScriptã‚³ãƒ¼ãƒ‰ã‚’æ§‹ç¯‰ã™ã‚‹ (å€‹åˆ¥ã‚³ãƒãƒ³ãƒ‰ã€15000æ–‡å­—ä»¥å†…)
         * @param {Array<{y: number, z: number, color: string}>} layoutData å¤‰æ›æ¸ˆã¿ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆãƒ‡ãƒ¼ã‚¿
         * @param {number} startX Xåº§æ¨™
         * @param {number} startY Yåº§æ¨™
         * @param {number} startZ Zåº§æ¨™
         * @param {number} blockSize ãƒ‰ãƒƒãƒˆçµµã®è¾ºã®é•·ã•
         * @returns {string[]} åˆ†å‰²ã•ã‚ŒãŸCode Blockã®ã‚³ãƒ¼ãƒ‰æ–‡å­—åˆ—ã®é…åˆ—
         */
        function generateBloxdCode_IndividualPositions_SplitByChar(layoutData, startX, startY, startZ, blockSize) {
            
            // 15000æ–‡å­—åˆ¶é™ã«å¯¾ã—ã€å®‰å…¨ãƒãƒ¼ã‚¸ãƒ³ã¨ã—ã¦14900æ–‡å­—ã‚’ä½¿ç”¨
            const MAX_CHARS_PER_CHUNK = 14900; 

            // 1. ã™ã¹ã¦ã®ãƒ–ãƒ­ãƒƒã‚¯ã®åº§æ¨™ã‚’api.setBlock(x, y, z, "Block")å½¢å¼ã®ã‚³ãƒãƒ³ãƒ‰ã¨ã—ã¦ç”Ÿæˆ
            const allCommands = layoutData.map(item => {
                
                // ã€åº§æ¨™åè»¢ã€‘: Bloxdã®Yè»¸ã¯ä¸Šå‘ãï¼ˆé«˜ã•ï¼‰ã€ç”»åƒã®Yè»¸ã¯ä¸‹å‘ã
                // ç”»åƒã®Yåº§æ¨™ (item.y): 0(ä¸Š)ã‹ã‚‰blockSize-1(ä¸‹)ã«å¢—åŠ 
                // Bloxdã®Yåº§æ¨™ (wy): startY(ä¸‹)ã‹ã‚‰ä¸Šã«å¢—åŠ 
                // ä¸Šä¸‹åè»¢ã‚’ä¿®æ­£ã™ã‚‹ãŸã‚ã€[blockSize - 1 - item.y] ã‚’è¨ˆç®—ã—ã¦ãƒãƒƒãƒ”ãƒ³ã‚°
                const reversedY = blockSize - 1 - item.y; 
                
                // ã€Zè»¸åè»¢ã€‘: å·¦å³åè»¢ã‚’ä¿®æ­£ã™ã‚‹ãŸã‚ã€Zè»¸ã‚‚åè»¢
                const reversedZ = blockSize - 1 - item.z; 

                // Xã¯å›ºå®šï¼ˆå£ã®åšã¿æ–¹å‘ï¼‰
                const wx = startX;
                // Yã¯é«˜ã•æ–¹å‘ï¼ˆä¸Šä¸‹åè»¢ã‚’ä¿®æ­£ï¼‰
                const wy = startY + reversedY; 
                // Zã¯å¹…æ–¹å‘ï¼ˆå·¦å³åè»¢ã‚’ä¿®æ­£ï¼‰
                const wz = startZ + reversedZ; 

                const blockName = item.color + BASE_BLOCK_TYPE_FULL;
                
                // åº§æ¨™ã®é…åˆ—ã§ã¯ãªãã€å€‹åˆ¥ã®å¼•æ•°ã‚’ä½¿ç”¨
                return `api.setBlock(${wx},${wy},${wz},"${blockName}")`;
            });
            
            const codeBlockChunks = [];
            let currentChunk = [];
            let currentLength = 0;

            // 2. ã‚³ãƒãƒ³ãƒ‰ãƒªã‚¹ãƒˆã‚’æ–‡å­—æ•°åˆ¶é™ã§åˆ†å‰²
            allCommands.forEach((command) => {
                // ã‚³ãƒãƒ³ãƒ‰ã®å¾Œã«ç¶šãåŒºåˆ‡ã‚Šæ–‡å­— (ã‚«ãƒ³ãƒ) ã®é•·ã•ã‚’è€ƒæ…®ã— +1
                const commandLength = command.length + 1; 

                if (currentLength + commandLength > MAX_CHARS_PER_CHUNK && currentChunk.length > 0) {
                    // ç¾åœ¨ã®ãƒãƒ£ãƒ³ã‚¯ã‚’çµ‚äº†ã—ã€æ–°ã—ã„ãƒãƒ£ãƒ³ã‚¯ã‚’é–‹å§‹
                    codeBlockChunks.push(currentChunk);
                    currentChunk = [];
                    currentLength = 0;
                }
                
                currentChunk.push(command);
                currentLength += commandLength;
            });
            
            // æœ€å¾Œã®ãƒãƒ£ãƒ³ã‚¯ã‚’è¿½åŠ 
            if (currentChunk.length > 0) {
                codeBlockChunks.push(currentChunk);
            }
            
            const finalCodeBlocks = [];

            // 3. å„ãƒãƒ£ãƒ³ã‚¯ï¼ˆCode Blockï¼‰ã‚’ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã§çµåˆã—ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿½åŠ 
            codeBlockChunks.forEach((chunk, index) => {
                const commands = [...chunk];
                
                // æœ€å¾Œã®Code Blockã«ã®ã¿å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿½åŠ 
                if (index === codeBlockChunks.length - 1) {
                    commands.push('api.sendMessage(myId,"\\u2705 \\u30C9\\u30C3\\u30C8\\u7D75\\u3092\\u63CF\\u753B\\u3057\\u307E\\u3057\\u305F\\uFF01")');
                } else {
                    // å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒãªã„Code Blockã«ã‚‚ã€å®Ÿè¡Œç¢ºèªã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿½åŠ 
                    commands.push(`api.sendMessage(myId,"\\u2714 Code Block ${index + 1} \\u304C\\u5B9F\\u884C\\u3055\\u308C\\u307E\\u3057\\u305F\\u3002\\u7D9A\\u304D\\u306B\\u6B21\\u306E Block \\u3092\\u5B9F\\u884C\\u3057\\u3066\\u304F\\u3060\\u3055\\u3044\\u3002")`);
                }
                
                // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è¦æ±‚ã©ãŠã‚Šã‚«ãƒ³ãƒ (,) ã§çµåˆ
                finalCodeBlocks.push(commands.join(','));
            });

            return finalCodeBlocks;
        }

        /**
         * ç”Ÿæˆã•ã‚ŒãŸã‚³ãƒ¼ãƒ‰ã«åŸºã¥ã„ã¦UIã‚’æ›´æ–°ã—ã€ã‚¿ãƒ–ã‚’å‹•çš„ã«ç”Ÿæˆã™ã‚‹
         */
        function updateOutputUI(codeBlocks) {
            const tabButtons = document.getElementById('tabButtons');
            const tabContent = document.getElementById('tabContent');
            if (!tabButtons || !tabContent) return; 

            // æ—¢å­˜ã®ãƒœã‚¿ãƒ³ã¨ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ã‚¯ãƒªã‚¢
            tabButtons.innerHTML = ''; 
            const copyMessage = document.getElementById('copyMessage');
            if (copyMessage) {
                tabContent.innerHTML = '';
                tabContent.appendChild(copyMessage);
            }
            
            codeBlocks.forEach((code, index) => {
                const blockId = index + 1;
                const charCount = code.length;
                const commandCount = code.split(/api\.setBlock/).length - 1; 

                // --- 1. Create Tab Button ---
                const button = document.createElement('button');
                button.textContent = `Block ${blockId} (${commandCount}ã‚³ãƒãƒ³ãƒ‰ / ${charCount}æ–‡å­—)`;
                button.className = `tab-button px-4 py-3 text-sm rounded-t-lg transition duration-150 text-gray-700 hover:bg-gray-100 whitespace-nowrap`;
                button.setAttribute('data-target', `codeBlock${blockId}`);
                button.onclick = function() { switchTab(blockId); };
                tabButtons.appendChild(button);

                // --- 2. Create Tab Pane (Content) ---
                const pane = document.createElement('div');
                pane.id = `codeBlock${blockId}`;
                pane.className = 'tab-pane hidden';
                pane.setAttribute('data-block-id', blockId);

                const textarea = document.createElement('textarea');
                textarea.id = `outputCode${blockId}`;
                textarea.rows = '12';
                textarea.readOnly = true;
                // ã‚³ãƒ¼ãƒ‰ã‚¨ãƒªã‚¢ã‚’ãƒ€ãƒ¼ã‚¯ãƒ†ãƒ¼ãƒã«å¤‰æ›´
                textarea.className = 'w-full p-4 border border-gray-700 rounded-lg bg-code-dark text-lime-400 font-mono text-xs custom-scrollbar shadow-inner';
                textarea.value = code;

                const copyButton = document.createElement('button');
                copyButton.textContent = `Block ${blockId} ã®ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼`;
                copyButton.className = 'copy-btn mt-3 px-6 py-2 bg-bloxd-primary text-white font-semibold rounded-full hover:bg-blue-600 transition duration-300 shadow-md';
                copyButton.setAttribute('data-target', `outputCode${blockId}`);
                copyButton.onclick = copyCode; 

                pane.appendChild(textarea);
                pane.appendChild(copyButton);
                tabContent.insertBefore(pane, copyMessage); 
            });

            // Activate the first tab if blocks exist
            if (codeBlocks.length > 0) {
                switchTab(1);
            }
        }
        
        /**
         * ã‚¿ãƒ–ã®åˆ‡ã‚Šæ›¿ãˆå‡¦ç†
         */
        function switchTab(blockId) {
            const tabButtons = document.querySelectorAll('.tab-button');
            const tabPanes = document.querySelectorAll('.tab-pane');

            tabPanes.forEach(pane => {
                pane.classList.add('hidden');
            });
            tabButtons.forEach(button => {
                button.classList.remove('active');
            });
            
            const targetPane = document.getElementById(`codeBlock${blockId}`);
            const targetButton = document.querySelector(`.tab-button[data-target="codeBlock${blockId}"]`);

            if (targetPane) {
                targetPane.classList.remove('hidden');
            }
            if (targetButton) {
                targetButton.classList.add('active');
            }
        }

        /* ã‚³ãƒ¼ãƒ‰ã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ */
        function copyCode(event) {
            const targetId = event.currentTarget.getAttribute('data-target');
            const outputCodeElement = document.getElementById(targetId);
            
            if (!outputCodeElement || !outputCodeElement.value || outputCodeElement.value.startsWith('/*')) {
                showCustomMessage("ã‚³ãƒ”ãƒ¼ã™ã‚‹ã‚³ãƒ¼ãƒ‰ãŒã‚ã‚Šã¾ã›ã‚“ã€‚å…ˆã«ç”»åƒã‚’å¤‰æ›ã—ã¦ãã ã•ã„ã€‚", 'error');
                return;
            }

            outputCodeElement.select();
            try {
                // document.execCommand('copy') ã¯éæ¨å¥¨ã§ã™ãŒã€iFrameå†…ã§å®‰å…¨ã«å‹•ä½œã™ã‚‹ãŸã‚ä½¿ç”¨
                document.execCommand('copy'); 
                var copyMessage = document.getElementById('copyMessage');
                if (copyMessage) {
                    copyMessage.classList.remove('hidden');
                    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å°‘ã—å¼·èª¿
                    copyMessage.textContent = `âœ… Block ${event.currentTarget.textContent.match(/Block (\d+)/)[1]} ã®ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼`;
                    setTimeout(function() { copyMessage.classList.add('hidden'); }, 2000);
                }
            } catch (err) {
                console.error('Copy command failed:', err);
                showCustomMessage('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ‰‹å‹•ã§ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã‹ã‚‰ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„ã€‚', 'error');
            }
        }

        /* DOMContentLoadedå¾Œã«ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š */
        document.addEventListener('DOMContentLoaded', function() {
            var resolutionSelect = document.getElementById('resolution');
            
            // åˆæœŸè¨­å®šã®å®Ÿè¡Œ
            updatePreviewCanvasSize(parseInt(resolutionSelect.value));

            const convertButton = document.getElementById('convertButton');
            if (convertButton) convertButton.addEventListener('click', startConversion);
            
            resolutionSelect.addEventListener('change', function() {
                var newSize = parseInt(resolutionSelect.value);
                updatePreviewCanvasSize(newSize);
                
                const previewResolution = document.getElementById('previewResolution');
                if(previewResolution) previewResolution.textContent = newSize + "x" + newSize;
                
                var resetMessage = '/* Code Blockã®åº§æ¨™ã¨è§£åƒåº¦ã‚’è¨­å®šã—ã€ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ã€Œå¤‰æ›ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚ */';

                const outputSection = document.getElementById('outputSection');
                if(outputSection) outputSection.style.display = 'none';
                
                const tabButtons = document.getElementById('tabButtons');
                if(tabButtons) tabButtons.innerHTML = '';

                const tabContent = document.getElementById('tabContent');
                const copyMessage = document.getElementById('copyMessage');
                if (tabContent) {
                    tabContent.innerHTML = `
                        <!-- Code Block ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã¯JSã§å‹•çš„ã«è¿½åŠ ã•ã‚Œã¾ã™ -->
                        <textarea id="outputCodePlaceholder" rows="12" readonly class="w-full p-4 border border-gray-700 rounded-lg bg-code-dark text-lime-400 font-mono text-xs custom-scrollbar shadow-inner">${resetMessage}</textarea>
                    `;
                    if (copyMessage) tabContent.appendChild(copyMessage);
                }
            });
            
            // åˆå›è¡¨ç¤ºæ™‚ã®ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼
            const tabContent = document.getElementById('tabContent');
            const resetMessage = '/* Code Blockã®åº§æ¨™ã¨è§£åƒåº¦ã‚’è¨­å®šã—ã€ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ã€Œå¤‰æ›ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚ */';
            if (tabContent) {
                tabContent.innerHTML = `
                    <textarea id="outputCodePlaceholder" rows="12" readonly class="w-full p-4 border border-gray-700 rounded-lg bg-code-dark text-lime-400 font-mono text-xs custom-scrollbar shadow-inner">${resetMessage}</textarea>
                    <p id="copyMessage" class="mt-3 px-3 py-1 bg-green-100 text-green-700 font-semibold rounded inline-block hidden">âœ… ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼</p>
                `;
            }

        });

    </script>
</body>
</html>

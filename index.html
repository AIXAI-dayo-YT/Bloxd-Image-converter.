<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bloxd ãƒ‰ãƒƒãƒˆçµµã‚³ãƒ³ãƒãƒ¼ã‚¿ãƒ¼ (é™æ­¢ç”»)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'bloxd-blue': '#4a90e2',
                        'bloxd-dark': '#1e293b',
                        'bloxd-wool': '#f3f4f6',
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
        }
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #64748b;
            border-radius: 10px;
        }
        /* ãƒ”ã‚¯ã‚»ãƒ«ã‚¢ãƒ¼ãƒˆè¡¨ç¤ºã®ãŸã‚ã®è¨­å®š */
        .image-rendering-pixelated {
            image-rendering: optimizeSpeed; /* Webkit browsers */
            image-rendering: -moz-crisp-edges; /* Firefox */
            image-rendering: -o-crisp-edges; /* Opera */
            image-rendering: pixelated; /* Standard */
        }
    </style>
</head>
<body class="p-4 sm:p-8 bg-bloxd-dark min-h-screen flex justify-center">

    <div id="app" class="w-full max-w-4xl bg-white shadow-2xl rounded-xl p-6 sm:p-10">
        
        <h1 class="text-3xl sm:text-4xl font-extrabold text-red-600 mb-2 text-center">
            ğŸ§± Bloxd ãƒ‰ãƒƒãƒˆçµµã‚³ãƒ³ãƒãƒ¼ã‚¿ãƒ¼
        </h1>
        <p class="text-center text-gray-600 mb-8">
            ç”»åƒã‚’ãƒ–ãƒ­ãƒƒã‚¯é…ç½®ã‚³ãƒ¼ãƒ‰ã«å¤‰æ›ã—ã¾ã™ã€‚è§£åƒåº¦ (10x10 ã€œ 100x100) ã‚’é¸æŠå¯èƒ½ã§ã™ã€‚
        </p>

        <!-- ã‚¹ãƒ†ãƒƒãƒ— 1: è¨­å®šã¨å…¥åŠ› -->
        <div class="space-y-6 mb-10 p-6 bg-bloxd-wool rounded-lg border border-gray-200">
            <h2 class="text-2xl font-bold text-gray-800 border-b pb-2">ã‚¹ãƒ†ãƒƒãƒ— 1: è¨­å®šã¨ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- è¨­å®š -->
                <div class="col-span-1 md:col-span-1 space-y-3">
                    <label class="block text-sm font-medium text-gray-700">ãƒ‘ãƒ¬ãƒƒãƒˆãƒ–ãƒ­ãƒƒã‚¯</label>
                    <div class="bg-gray-100 p-3 rounded-lg border border-gray-300">
                        <p class="text-lg font-semibold text-gray-900">Concrete (16è‰²)</p>
                        <p class="text-xs text-gray-500">ã”æŒ‡å®šã®ã‚³ãƒ³ã‚¯ãƒªãƒ¼ãƒˆãƒ–ãƒ­ãƒƒã‚¯ã‚’ä½¿ç”¨</p>
                    </div>

                    <label for="resolution" class="block text-sm font-medium text-gray-700">è§£åƒåº¦ (N x N ãƒ–ãƒ­ãƒƒã‚¯)</label>
                    <select id="resolution" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-bloxd-blue focus:border-bloxd-blue transition duration-150">
                        <!-- 10ã‹ã‚‰100ã¾ã§10åˆ»ã¿ã§ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¨­å®š -->
                        <option value="10">10x10</option>
                        <option value="20" selected>20x20 (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ)</option>
                        <option value="30">30x30</option>
                        <option value="40">40x40</option>
                        <option value="50">50x50</option>
                        <option value="60">60x60</option>
                        <option value="70">70x70</option>
                        <option value="80">80x80</option>
                        <option value="90">90x90</option>
                        <option value="100">100x100</option>
                    </select>
                </div>

                <!-- ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ› -->
                <div class="col-span-1 md:col-span-2">
                    <label for="imageUpload" class="block text-lg font-medium text-gray-800 mb-2">
                        ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
                    </label>
                    <input type="file" id="imageUpload" accept="image/*" class="w-full text-sm text-gray-500
                        file:mr-4 file:py-2 file:px-4
                        file:rounded-full file:border-0
                        file:text-sm file:font-semibold
                        file:bg-bloxd-blue file:text-white
                        hover:file:bg-indigo-600 cursor-pointer
                    "/>
                    <p class="mt-2 text-xs text-gray-500">â€»å¤‰æ›é€Ÿåº¦ã®ãŸã‚ã€ç”»åƒã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã¯å°ã•ã„ã‚‚ã®ãŒæ¨å¥¨ã•ã‚Œã¾ã™ã€‚</p>
                </div>
            </div>
            
            <div class="pt-4 flex justify-center">
                <button id="convertButton"
                    class="px-8 py-3 bg-red-500 text-white font-bold rounded-xl shadow-lg hover:bg-red-600 transition duration-300 disabled:opacity-50">
                    ğŸ–¼ï¸ ç”»åƒã‚’ãƒ–ãƒ­ãƒƒã‚¯ã‚³ãƒ¼ãƒ‰ã«å¤‰æ›
                </button>
            </div>
        </div>

        <!-- ã‚¹ãƒ†ãƒƒãƒ— 2: ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¨å‡ºåŠ› -->
        <div id="outputSection" class="space-y-6" style="display: none;">
            <h2 class="text-2xl font-bold text-gray-800 border-b pb-2">ã‚¹ãƒ†ãƒƒãƒ— 2: çµæœã¨Bloxdã‚³ãƒ¼ãƒ‰</h2>

            <div class="flex flex-col md:flex-row gap-6">
                <!-- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ -->
                <div class="md:w-1/3 p-4 bg-gray-100 rounded-lg shadow-inner">
                    <h3 class="font-semibold text-gray-700 mb-2">å¤‰æ›ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ (<span id="previewResolution">20x20</span>)</h3>
                    <canvas id="previewCanvas" width="20" height="20" class="w-full h-auto rounded-md shadow-lg border border-gray-300 image-rendering-pixelated"></canvas>
                    <p class="text-xs text-gray-500 mt-2">â€»å¤‰æ›å¾Œã®ã‚³ãƒ³ã‚¯ãƒªãƒ¼ãƒˆãƒ–ãƒ­ãƒƒã‚¯è‰²ã§è¡¨ç¤ºã€‚</p>
                </div>

                <!-- ã‚³ãƒ¼ãƒ‰å‡ºåŠ› -->
                <div class="md:w-2/3">
                    <h3 class="font-semibold text-gray-700 mb-2">Bloxd World Code (JavaScript)</h3>
                    <textarea id="outputCode" rows="15" readonly class="w-full p-4 border border-gray-400 rounded-lg bg-gray-900 text-green-400 font-mono text-xs custom-scrollbar"></textarea>
                    <button id="copyButton" class="mt-3 px-4 py-2 bg-bloxd-blue text-white rounded-lg hover:bg-indigo-600 transition duration-300">
                        ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼
                    </button>
                    <p id="copyMessage" class="mt-2 text-sm text-green-500 hidden">ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼</p>
                </div>
            </div>
        </div>

        <div id="loading" class="text-center text-lg text-bloxd-blue font-semibold mt-10 hidden">
            <div class="animate-spin inline-block w-8 h-8 border-4 border-bloxd-blue border-t-transparent rounded-full"></div>
            <p class="mt-3">è§£æã¨ã‚³ãƒ¼ãƒ‰ç”Ÿæˆä¸­...</p>
        </div>

    </div>

    <script>
        // å®šæ•°ã‚’è¨­å®š
        const BASE_BLOCK_TYPE = " Concrete"; // è‰²åã¨çµåˆã—ã¦ "Red Concrete" ã«ãªã‚‹
        const MAX_PREVIEW_SIZE = 400; // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®æœ€å¤§è¡¨ç¤ºã‚µã‚¤ã‚º (px)
        
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼æŒ‡å®šã®ã‚³ãƒ³ã‚¯ãƒªãƒ¼ãƒˆãƒ–ãƒ­ãƒƒã‚¯ãƒ‘ãƒ¬ãƒƒãƒˆ (è‰²åã¨RGBè¿‘ä¼¼å€¤)
        const BLOXD_COLORS = {
            'White': [200, 203, 207],
            'Light Gray': [135, 137, 140],
            'Gray': [80, 80, 84],
            'Black': [25, 27, 30],
            'Brown': [95, 60, 42],
            'Red': [142, 38, 32],
            'Orange': [220, 94, 25],
            'Yellow': [237, 178, 20],
            'Lime': [95, 169, 21],
            'Green': [77, 98, 32],
            'Cyan': [18, 126, 133],
            'Light Blue': [65, 137, 186],
            'Blue': [43, 44, 138],
            'Purple': [112, 45, 166],
            'Magenta': [178, 59, 141],
            'Pink': [215, 108, 138]
        };

        /**
         * 2ã¤ã®RGBè‰²ã®é–“ã®è·é›¢ (R^2 + G^2 + B^2) ã‚’è¨ˆç®—
         */
        function colorDistance(rgb1, rgb2) {
            return Math.pow(rgb1[0] - rgb2[0], 2) + Math.pow(rgb1[1] - rgb2[1], 2) + Math.pow(rgb1[2] - rgb2[2], 2);
        }

        /**
         * æœ€ã‚‚è¿‘ã„Bloxdã®ãƒ–ãƒ­ãƒƒã‚¯è‰²ã‚’æ±ºå®š (ãƒ¦ãƒ¼ãƒ©ãƒŸã‚¢ãƒ³è·é›¢ã‚’ä½¿ç”¨)
         */
        function findNearestBloxdColor(targetRgb) {
            let minDistance = Infinity;
            let nearestColorName = 'White';

            for (const [name, rgb] of Object.entries(BLOXD_COLORS)) {
                const distance = colorDistance(targetRgb, rgb);
                if (distance < minDistance) {
                    minDistance = distance;
                    nearestColorName = name;
                }
            }
            return nearestColorName;
        }
        
        /**
         * ç”»åƒã‚’èª­ã¿è¾¼ã¿ã€æŒ‡å®šã‚µã‚¤ã‚ºã«ãƒªã‚µã‚¤ã‚ºã—ã€Bloxdãƒ–ãƒ­ãƒƒã‚¯ã‚³ãƒ¼ãƒ‰ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆ
         * @param {File} file - ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸç”»åƒãƒ•ã‚¡ã‚¤ãƒ«
         * @param {number} blockSize - ãƒ‰ãƒƒãƒˆçµµã®ã‚µã‚¤ã‚º (ä¾‹: 20)
         * @returns {Promise<string[]>} Bloxdã®è‰²ã®åå‰ã®é…åˆ— (blockSize * blockSize è¦ç´ )
         */
        function processImageToLayout(file, blockSize) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                const reader = new FileReader();

                reader.onload = (e) => {
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        canvas.width = blockSize;
                        canvas.height = blockSize;

                        // ç”»åƒã‚’æŒ‡å®šã‚µã‚¤ã‚ºã«æç”»ãƒ»ãƒªã‚µã‚¤ã‚º
                        ctx.drawImage(img, 0, 0, blockSize, blockSize);
                        
                        // ãƒ”ã‚¯ã‚»ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                        const imageData = ctx.getImageData(0, 0, blockSize, blockSize).data;
                        const layoutData = [];

                        // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”¨ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚’å–å¾—ã—ã€ãƒªã‚»ãƒƒãƒˆ
                        const previewCanvas = document.getElementById('previewCanvas');
                        const previewCtx = previewCanvas.getContext('2d');
                        
                        // ã‚­ãƒ£ãƒ³ãƒã‚¹ã®ã‚µã‚¤ã‚ºãŒæ—¢ã«æ›´æ–°ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’å‰æã«ã€ã‚¯ãƒªã‚¢
                        previewCtx.clearRect(0, 0, blockSize, blockSize); 
                        
                        // ãƒ”ã‚¯ã‚»ãƒ«ã”ã¨ã«å‡¦ç†
                        for (let i = 0; i < imageData.length; i += 4) {
                            const r = imageData[i];
                            const g = imageData[i + 1];
                            const b = imageData[i + 2];
                            
                            const bloxdColorName = findNearestBloxdColor([r, g, b]);
                            layoutData.push(bloxdColorName);

                            // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤ºç”¨: å¤‰æ›å¾Œã®ãƒ–ãƒ­ãƒƒã‚¯ã®è‰²ã‚’åæ˜ 
                            const bloxdRgb = BLOXD_COLORS[bloxdColorName];
                            previewCtx.fillStyle = "rgb(" + bloxdRgb[0] + "," + bloxdRgb[1] + "," + bloxdRgb[2] + ")";
                            
                            const pixelIndex = i / 4;
                            const x = pixelIndex % blockSize;
                            const y = Math.floor(pixelIndex / blockSize);
                            
                            // ã‚­ãƒ£ãƒ³ãƒã‚¹ãŒæ—¢ã«æ‹¡å¤§ã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€1ãƒ”ã‚¯ã‚»ãƒ«ãšã¤æç”»
                            previewCtx.fillRect(x, y, 1, 1);
                        }

                        resolve(layoutData);
                    };
                    img.src = e.target.result;
                };

                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }
        
        /**
         * ãƒ¡ã‚¤ãƒ³ã®å‡¦ç†ã‚’å®Ÿè¡Œã—ã€ã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆã™ã‚‹
         */
        async function startConversion() {
            const fileInput = document.getElementById('imageUpload');
            const resolutionSelect = document.getElementById('resolution');
            const outputCodeElement = document.getElementById('outputCode');
            const outputSection = document.getElementById('outputSection');
            const loading = document.getElementById('loading');
            
            const blockSize = parseInt(resolutionSelect.value); // é¸æŠã•ã‚ŒãŸè§£åƒåº¦ã‚’å–å¾—
            
            if (!fileInput.files[0]) {
                alert("ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚");
                return;
            }

            // UIã‚’æ›´æ–°
            loading.classList.remove('hidden');
            outputSection.style.display = 'none';

            // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚­ãƒ£ãƒ³ãƒã‚¹ã®ã‚µã‚¤ã‚ºã‚’æ›´æ–°
            updatePreviewCanvasSize(blockSize);

            try {
                // 1. ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆ
                const blockLayout = await processImageToLayout(fileInput.files[0], blockSize);
                
                // é…åˆ—ã‚’Bloxdã‚³ãƒ¼ãƒ‰ã«åŸ‹ã‚è¾¼ã‚€ãŸã‚ã®JavaScriptæ–‡å­—åˆ—ã«å¤‰æ›
                // ã“ã‚Œã«ã‚ˆã‚Šã€ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒªãƒ†ãƒ©ãƒ«å†…ã®ç«¶åˆã‚’é¿ã‘ã‚‹
                let layoutArrayString = '[\n    ';
                layoutArrayString += blockLayout.map(c => '"' + c + '"').join(', ');
                layoutArrayString += '\n]';

                // 2. Bloxd World Codeã‚’ç”Ÿæˆ
                const generatedCode = generateBloxdCode(layoutArrayString, blockSize);
                
                outputCodeElement.value = generatedCode;
                
                // UIã‚’æ›´æ–°
                document.getElementById('previewResolution').textContent = blockSize + "x" + blockSize;
                outputSection.style.display = 'block';
                loading.classList.add('hidden');

            } catch (error) {
                loading.classList.add('hidden');
                console.error("è§£æã‚¨ãƒ©ãƒ¼:", error);
                alert("ç”»åƒã®è§£æä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
            }
        }
        
        /**
         * ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚­ãƒ£ãƒ³ãƒã‚¹ã®HTMLå±æ€§ã¨ã‚¹ã‚¿ã‚¤ãƒ«ã‚’æ›´æ–°
         */
        function updatePreviewCanvasSize(blockSize) {
            const previewCanvas = document.getElementById('previewCanvas');
            
            // å†…éƒ¨è§£åƒåº¦ã‚’è¨­å®š
            previewCanvas.width = blockSize;
            previewCanvas.height = blockSize;
            
            // ãƒ”ã‚¯ã‚»ãƒ«ã‚¢ãƒ¼ãƒˆæ„Ÿã‚’å‡ºã™ãŸã‚ã«ã€é«˜å€ç‡ã§æç”» (CSSã§è¡¨ç¤ºã‚µã‚¤ã‚ºã‚’åˆ¶å¾¡)
            const scale = MAX_PREVIEW_SIZE / blockSize;
            
            // CSSã‚¹ã‚¿ã‚¤ãƒ«ã§è¡¨ç¤ºã‚µã‚¤ã‚ºã‚’è¨­å®š
            previewCanvas.style.width = (blockSize * scale) + 'px';
            previewCanvas.style.height = (blockSize * scale) + 'px';

            const ctx = previewCanvas.getContext('2d');
            
            // ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã®ã‚¹ã‚±ãƒ¼ãƒ«ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦ã‹ã‚‰å†è¨­å®š
            ctx.setTransform(1, 0, 0, 1, 0, 0); // ãƒªã‚»ãƒƒãƒˆ
            ctx.scale(scale, scale);
            ctx.imageSmoothingEnabled = false;
        }

        /**
         * æœ€çµ‚çš„ãªBloxd World Code (JavaScript) ã‚’æ§‹ç¯‰ã™ã‚‹
         * @param {string} layoutArrayString - æ–‡å­—åˆ—åŒ–ã•ã‚ŒãŸãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆé…åˆ— (N*N è¦ç´ )
         * @param {number} blockSize - ãƒ‰ãƒƒãƒˆçµµã®ã‚µã‚¤ã‚º
         * @returns {string} å®Œå…¨ãªBloxd World Code
         */
        function generateBloxdCode(layoutArrayString, blockSize) {
            // å®‰å…¨ãªæ–‡å­—åˆ—çµåˆã‚’ä½¿ç”¨ã—ã€Bloxdç’°å¢ƒã§ã®SyntaxErrorã‚’å®Œå…¨ã«å›é¿
            
            let code = "";
            code += "// ==========================================================\n";
            code += "// \uD83D\uDCBB Bloxd \u30C9\u30C3\u30C8\u7D75\u30B3\u30F3\u30D0\u30FC\u30BF\u30FC\u306B\u3088\u308B\u751F\u6210\u30B3\u30FC\u30C9 (\u9759\u6B62\u753B)\n";
            code += "// ==========================================================\n";
            code += "\n";
            code += "// \u8A2D\u7F6E\u65B9\u6CD5: \u91D1\u30D6\u30ED\u30C3\u30AF\u3092\u6301\u3063\u3066\u30EF\u30FC\u30EB\u30C9\u3092\u30AF\u30EA\u30C3\u30AF\u3059\u308B\u3068\u30AD\u30E3\u30F3\u30D0\u30B9\u304C\u751F\u6210\u3055\u308C\u3001\n";
            code += "//           \u30C1\u30E3\u30C3\u30C8\u3067 /draw \u3068\u5165\u529B\u3059\u308B\u3068\u30C9\u30C3\u30C8\u7D75\u304C\u63CF\u753B\u3055\u308C\u307E\u3059\u3002\n";
            code += "\n";
            code += "// ==========================================================\n";
            code += "// A. \u5B9A\u6570\u3068\u30C7\u30FC\u30BF\n";
            code += "// ==========================================================\n";
            code += 'const CANVAS_BLOCK = "White Concrete";\n';
            code += 'const DRAW_BLOCK_TYPE = " Concrete"; // \u4F8B: "Red" + " Concrete" = "Red Concrete"\n';
            code += 'const CANVAS_SIZE = ' + blockSize + '; // ' + blockSize + 'x' + blockSize + '\n';
            code += "\n";
            code += "// \u30B5\u30A4\u30C8\u751F\u6210\u30C7\u30FC\u30BF: \u30D6\u30ED\u30C3\u30AF\u30EC\u30A4\u30A2\u30A6\u30C8 (N*N \u8981\u7D20)\n";
            code += "const BLOCK_LAYOUT = " + layoutArrayString + ";\n";
            code += "\n";
            code += "// ==========================================================\n";
            code += "// B. \u63CF\u753B\u51E6\u7406\n";
            code += "// ==========================================================\n";
            code += "let canvasStartPos = {x: 0, y: 0, z: 0}; // \u30D7\u30EC\u30A4\u30E4\u30FC\u304C\u91D1\u30D6\u30ED\u30C3\u30AF\u3067\u8A2D\u5B9A\u3059\u308B\n";
            code += "\n";
            code += "function _drawDotArt() {\n";
            code += "    if (BLOCK_LAYOUT.length !== CANVAS_SIZE * CANVAS_SIZE) {\n";
            code += '        api.sendMessage("All", "âš ï¸ \u30EC\u30A4\u30A2\u30A6\u30C8\u30C7\u30FC\u30BF\u304C\u4E0D\u6B63\u3067\u3059 (" + BLOCK_LAYOUT.length + "\u8981\u7D20)\u3002");\n';
            code += "        return;\n";
            code += "    }\n";
            code += "\n";
            code += "    // \u30EC\u30A4\u30A2\u30A6\u30C8\u30C7\u30FC\u30BF\u306B\u57FA\u3065\u3044\u3066\u30D6\u30ED\u30C3\u30AF\u3092\u66F4\u65B0\n";
            code += "    for (let y = 0; y < CANVAS_SIZE; y++) {\n";
            code += "        for (let z = 0; z < CANVAS_SIZE; z++) {\n";
            code += "            const blockIndex = y * CANVAS_SIZE + z;\n";
            code += "            const colorName = BLOCK_LAYOUT[blockIndex];\n";
            code += "            \n";
            code += "            // X\u8EF8\u306B\u5782\u76F4\u306A\u7E26\u578B\u30AD\u30E3\u30F3\u30D0\u30B9\u306B\u8A2D\u7F6E\n";
            code += "            const wx = canvasStartPos.x;\n";
            code += "            const wy = canvasStartPos.y + y;\n";
            code += "            const wz = canvasStartPos.z + z;\n";
            code += "            \n";
            code += "            // \u8272\u540D\u3068\u30D6\u30ED\u30C3\u30AF\u30BF\u30A4\u30D7\u3092\u7D50\u5408 \n";
            code += "            api.setBlock(wx, wy, wz, colorName + DRAW_BLOCK_TYPE); \n";
            code += "        }\n";
            code += "    }\n";
            code += '    api.sendMessage("All", "\u2705 \u30C9\u30C3\u30C8\u7D75\u3092\u63CF\u753B\u3057\u307E\u3057\u305F\uFF01");\n';
            code += "}\n";
            code += "\n";
            code += "\n";
            code += "// ==========================================================\n";
            code += "// C. \u30D7\u30EC\u30A4\u30E4\u30FC\u30B3\u30DE\u30F3\u30C9\u3068\u30AD\u30E3\u30F3\u30D0\u30B9\u751F\u6210\n";
            code += "// ==========================================================\n";
            code += "playerCommand = (p, message) => {\n";
            code += '    if (message === "/draw") {\n';
            code += "        if (canvasStartPos.x === 0 && canvasStartPos.y === 0 && canvasStartPos.z === 0) {\n";
            code += '             api.sendMessage(p, "\u26A0\uFE0F \u307E\u305A\u91D1\u30D6\u30ED\u30C3\u30AF\u3067\u30AD\u30E3\u30F3\u30D0\u30B9\u3092\u751F\u6210\u3057\u3066\u304F\u3060\u3055\u3044\u3002");\n';
            code += "             return true;\n";
            code += "        }\n";
            code += "        _drawDotArt();\n";
            code += "        return true;\n";
            code += "    }\n";
            code += "    return false;\n";
            code += "};\n";
            code += "\n";
            code += "// \u91D1\u30D6\u30ED\u30C3\u30AF\u3092\u6301\u3063\u3066\u30AF\u30EA\u30C3\u30AF\u3059\u308B\u3068\u30AD\u30E3\u30F3\u30D0\u30B9\u3092\u751F\u6210\u3057\u3001\u5EA7\u6A19\u3092\u4FDD\u5B58\n";
            code += "onPlayerAltAction = (p, x, y, z, block, targetEId) => {\n";
            code += '    if (block !== "Block of Gold") return;\n';
            code += "\n";
            code += "    const playerPos = api.getPosition(p);\n";
            code += "    const facingInfo = api.getPlayerFacingInfo(p);\n";
            code += "    if (!facingInfo || !facingInfo.dir) return;\n";
            code += "\n";
            code += "    const dir = facingInfo.dir;\n";
            code += "    const horizontalLength = Math.sqrt(dir[0] * dir[0] + dir[2] * dir[2]);\n";
            code += "    if (horizontalLength === 0) return; \n";
            code += "    \n";
            code += "    const CANVAS_OFFSET_DIST = 10;\n";
            code += "    const unitX = dir[0] / horizontalLength;\n";
            code += "    const unitZ = dir[2] / horizontalLength;\n";
            code += "    \n";
            code += "    const centerX = Math.floor(playerPos[0] + unitX * CANVAS_OFFSET_DIST);\n";
            code += "    const centerZ = Math.floor(playerPos[2] + unitZ * CANVAS_OFFSET_DIST);\n";
            code += "    \n";
            code += "    const startX = centerX;\n";
            code += "    const startY_canvas = Math.floor(playerPos[1]); \n";
            code += "    const startZ = centerZ - Math.floor(CANVAS_SIZE / 2); \n";
            code += "\n";
            code += "    // \u30B0\u30ED\u30FC\u30D0\u30EB\u5909\u6570\u306B\u5EA7\u6A19\u3092\u4FDD\u5B58\n";
            code += "    canvasStartPos = { x: startX, y: startY_canvas, z: startZ };\n";
            code += "\n";
            code += "    // \u30AD\u30E3\u30F3\u30D0\u30B9\u3092\u30EF\u30FC\u30EB\u30C9\u306B\u8A2D\u7F6E (\u521D\u671F\u5316\u3068\u3057\u3066White Concrete\u3092\u4F7F\u7528)\n";
            code += "    for (let Y = 0; Y < CANVAS_SIZE; Y++) {\n";
            code += "        for (let Z = 0; Z < CANVAS_SIZE; Z++) {\n";
            code += "            api.setBlock(startX, startY_canvas + Y, startZ + Z, CANVAS_BLOCK);\n";
            code += "        }\n";
            code += "    }\n";
            code += '    api.sendMessage(p, "\u2705 \u30AD\u30E3\u30F3\u30D0\u30B9\u3092\u751F\u6210\u3057\u307E\u3057\u305F\uFF01\u30C1\u30E3\u30C3\u30C8\u3067 /draw \u3068\u5165\u529B\u3057\u3066\u63CF\u753B\u3057\u307E\u3059\u3002");\n';
            code += '    return "preventAction";\n';
            code += "};\n";
            
            return code;
        }
        
        // ã‚³ãƒ¼ãƒ‰ã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼
        function copyCode() {
            const outputCodeElement = document.getElementById('outputCode');
            outputCodeElement.select();
            // document.execCommand('copy') ã¯éæ¨å¥¨ã§ã™ãŒã€iFrameå†…ã§ç¢ºå®ŸãªãŸã‚ä½¿ç”¨
            try {
                document.execCommand('copy');
                const copyMessage = document.getElementById('copyMessage');
                copyMessage.classList.remove('hidden');
                setTimeout(() => copyMessage.classList.add('hidden'), 2000);
            } catch (err) {
                console.error('Copy command failed:', err);
            }
        }

        // DOMContentLoadedå¾Œã«ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
        document.addEventListener('DOMContentLoaded', () => {
            const resolutionSelect = document.getElementById('resolution');
            
            // åˆæœŸè§£åƒåº¦ã§ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
            updatePreviewCanvasSize(parseInt(resolutionSelect.value));

            // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã§è¨­å®š
            document.getElementById('convertButton').addEventListener('click', startConversion);
            document.getElementById('copyButton').addEventListener('click', copyCode);
            
            // è§£åƒåº¦å¤‰æ›´æ™‚ã«ã‚‚ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æ›´æ–°
            resolutionSelect.addEventListener('change', () => {
                const newSize = parseInt(resolutionSelect.value);
                updatePreviewCanvasSize(newSize);
                document.getElementById('previewResolution').textContent = newSize + "x" + newSize;
                // è§£åƒåº¦å¤‰æ›´æ™‚ã¯ã‚³ãƒ¼ãƒ‰ã¨ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆç”»åƒå‡¦ç†ã¯ã¾ã å®Ÿè¡Œã•ã‚Œã¦ã„ãªã„ï¼‰
                document.getElementById('outputSection').style.display = 'none';
                document.getElementById('outputCode').value = '// è§£åƒåº¦ã‚’å¤‰æ›´ã—ã¾ã—ãŸã€‚ç”»åƒã‚’å†åº¦ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ã€Œå¤‰æ›ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚';
            });
        });

    </script>
</body>
</html>